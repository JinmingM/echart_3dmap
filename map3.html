<!DOCTYPE html>
<html>
<head>
    <title>3Dmap</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./css/index1.css">
    <script src="js/jquery-3.3.1.js"></script>
    <script src="js/echarts.min.js"></script>
    <script src="http://echarts.baidu.com/dist/echarts-gl.min.js"></script>
    <script src="js/province/guangdong.js"></script>
    <script src="js/data1.js"></script>
    <script src="js/data2.js"></script>
    <script src="js/china.js"></script>

</head>

<body background="bg.jpg">
    <div id ="title">
        <p align="center"><font size="5" face="arial" color="white">药通网地图信息平台</font></p>
        <p align="center"><font size="5" face="arial" color="white">Map Information Platform Of YTW</font></p>
    </div>

    <div class="list" id="list">
        <div class="list-topbar clearfix">
            <a class="province station" data-direction="1">全国各省站点数</a> 
        </div>
        <div id="dataList" class="table-wrap">  
            <table class="list-table">
                <thead>
                    <tr>
                        <th>&nbsp;&nbsp;&nbsp;&nbsp;</th>
                        <th class="province">省份<span class="sep"></span></th>
                        <th class="station-num">站点数<span class="sep"></span></th>
                        <th class="proportion">占比(%)</th>
                    </thead>
                    <tbody id="tbody1">
                        
                    </tbody>
            </table>  
        </div>
    </div>

    <div class="list" id="list-chart" onClick="Converter(this)">
        <div id="dataChart" class="table-chart">  
            <div id="chart" style="width: 100%;height:100%;"></div>
        </div>
    </div>
    <div class="list" id="list-chart1" onClick="Converter(this)">
        <div id="dataChart1" class="table-chart">  
            <div id="chart1" style="width: 100%;height:100%;"></div>
        </div>
    </div>
    <div class="list" id="list-chart2" onClick="Converter(this)">
        <div id="dataChart2" class="table-chart">  
            <div id="chart2" style="width: 100%;height:100%;"></div>
        </div>
    </div>
    <div class="list" id="list-chart-b" onClick="Converter1(this)">
        <div id="dataChart3" style="width: 100%;height:100%;">  
            <div id="chart3" style="width: 100%;height:100%;"></div>
        </div>
    </div>

    <div id ="next">
        <button class="button"type="button" onClick="next_func()">进入  下一级</button>
    </div>
    <div id ="pre">
        <button class="button"type="button" onClick="pre_func()">返回  上一级</button>
    </div>
    <div id="main"></div>

    <script type="text/javascript">
        var chart = echarts.init(document.getElementById('main'));
        var min=0,max=30;
        var next_pr = 'guangdong';
        var next_button = document.getElementById("next");
        var pre_button = document.getElementById("pre");
        var province = new Map([["安徽省","anhui"],["福建省","fujian"],["甘肃省","gansu"],["广东省","guangdong"],["广西壮族自治区","guangxi"],["贵州省","guizhou"],["海南省","hainan"],["河北省","hebei"],["河南省","henan"],["黑龙江省","heilongjiang"],["吉林省","jilin"],["江苏省","jiangsu"],["湖北省","hubei"],["湖南省","hunan"],["宁夏回族自治区","ningxia"],["江西省","jiangxi"],["辽宁省","liaoning"],["内蒙古自治区","neimeng"],["青海省","qinghai"],["山西省","shanxi"],["陕西省","shanxi1"],["山东省","shandong"],["四川省","sichuan"],["西藏自治区","xizang"],["云南省","yunnan"],["浙江省","zhejiang"],["重庆市","chongqing"],["新疆维吾尔自治区","xinjiang"],["台湾省","taiwan"]]);

        creatChart('china');
        creatChart1(ytw_temp.prlist,"type1");
        createTable(ytw_data.prlist);

        function creatChart(string){
            chart.clear();

            var url = './json/'+string+'.json';
            console.log(url);
            $.getJSON(url, function (chinaGeoJSON) {
    
                echarts.registerMap('china', chinaGeoJSON);

                var regions = chinaGeoJSON.features.map(function (feature) {
                    var pr_name = feature.properties.name;
                    var pr_num = parseInt(Math.random()*(30));
                    for(var i=0,lens = ytw_data.prlist.length;i<lens;i++){
                        var temp = ytw_data.prlist[i].pr.substr(0,2);
                        if(temp == pr_name){           
                            pr_num = ytw_data.prlist[i].num;
                        }

                    }
                    return {
                        name: pr_name,
                        value: pr_num,//parseInt(Math.random()*(7)
                        height: 3
                    };
                });


                option=({
                    tooltip: {},
                    visualMap: {
                        show: false,
                        min: min,
                        max: max,
                        inRange: {
                            //color: ['#e0ffff', '#006edd']
                            //color: ['#FFFF24','#FF5702']
                            color: ['#68b2fd','#014fb2','#053e85']
                        },
                        calculable:true

                    },
                    series: [{
                        name:'china',
                            type: 'map3D',
                            map: 'china',

                            regionHeight: 3,

                            // 配置为全景贴图
                            // environment: 'bg.jpg',

                            // shading: 'realistic',
                            // silent: true,
                            // instancing: true,
                            // realisticMaterial: {
                            //     metalness: 1,
                            //     roughness: 0.2,
                            // },
                            // baseLayer: {
                            //     'urlTemplate': 'bg.jpg',
                            //     'subdomains': ['a', 'b', 'c', 'd']
                            // },
                            // altitudeScale: 2,
                            // postEffect: {
                            //     enable: true,
                            //     FXAA: {
                            //         enable: true
                            //     }
                            // },

                           label: {
                                show:true,
                                formatter:function(params){
                                    var content='',
                                    content=params.name;
                                    return content;
                                },
                                textStyle:{
                                    color:'#EECBAD',
                                    fontWeight : 'normal',
                                    fontSize : 5,
                                    backgroundColor: 'rgba(0,23,11,0)'
                                },
                                emphasis: {//对应的鼠标悬浮效果
                                    show: true,
                                    textStyle:{color:"#f00"}
                                } 
                            },

                            itemStyle: {

                                normal: {
                                    opacity:0.7,
                                    borderWidth: 0.4
                                }, //阴影效果
                                emphasis: {
                                    color: 'rgb(255,255,255)'
                                }
                            },

                            // light: {
                            //     main: {
                            //         intensity: 1,
                            //         shadow: true,
                            //         shadowQuality: 'high'
                            //     },
                            //     ambient: {
                            //         intensity: 0.
                            //     },
                            //     ambientCubemap: {
                            //         texture: 'Milkyway_Light.hdr',
                            //         exposure: 1,
                            //         diffuseIntensity: 0.5,
                            //         specularIntensity: 2
                            //     }
                            // },

                            viewControl: {
                                autoRotate: false,
                                distance: 150
                            },


                        data: regions
                    }]
                });
                chart.setOption(option);

            });
        }
        
        
        
        chart.on('click', function (params) {
            var name=params.data.name;
            var arr = Array();
            arr = option.series[0].data;
                
            params.data.height = 10;

            for(var i = 0,lens = arr.length;i<lens;i++){
                if(name==arr[i].name){
                    if(arr[i].height==3){
                        option.series[0].data[i].height = 6;
                        next_button.setAttribute("style","display:inline;");
                    }else if(arr[i].height==6){
                        option.series[0].data[i].height = 3;
                        next_button.setAttribute("style","display:none;");
                    }
                }
            }

            for(var key of province){
                if(key[0].substr(0,2) == name)
                {
                    console.log(key[1]);
                    next_pr = key[1];
                }
                
            }

            chart.setOption(option);
        });

        function next_func(){
            next_button.setAttribute("style","display:none;");
            pre_button.setAttribute("style","display:inline;");
            var str = "province/"+next_pr;
            creatChart(str);
        }

        function pre_func(){
            pre_button.setAttribute("style","display:none;");
            next_button.setAttribute("style","display:none;");
            creatChart("china");
        }

        function createTable(data){
    
            var tableData ="";
            var total = 1;
            var compare = function (obj1, obj2) {
                var val1 = obj1.num;
                var val2 = obj2.num;
                if (val1 > val2) {
                    return -1;
                } else if (val1 < val2) {
                    return 1;
                } else {
                    return 0;
                }            
            };

            data.sort(compare);

            for(var i=0;i<data.length;i++){
                total += data[i].num;
            }
            
            for(var i=0;i<data.length;i++){
                tableData+="<tr class=\"tr"+i+"\">";
                tableData+="<td class=\"index\"><span>"+(i+1)+"</span></td>";
                tableData+="<td class=\"province\">"+data[i].pr+"</td>";
                tableData+="<td class=\"station-num\">"+data[i].num+"</td>";
                var temp = (data[i].num/total)*100;
                tableData+="<td class=\"proportion\"><span class=\"txt\" style=\"bottom: 14.2px;\">"+temp.toFixed(2)+"%</span>";
                tableData+="<span class=\"box\" style=\"height: "+temp+"%;\"></span></td>"
                tableData+="</tr>";
            }

            
            $("#tbody1").html(tableData);
        }

        function creatChart1(list,type,type1){
            //
            var myChart = echarts.init(document.getElementById('chart'));
            var myChart1 = echarts.init(document.getElementById('chart1'));
            var myChart2 = echarts.init(document.getElementById('chart2'));
            var myChartb = echarts.init(document.getElementById('chart3'));
            myChartb.clear();
            var dataAxis = Array();
            var data = Array();
            var seriesData = Array();

            for(var i=0;i<list.length;i++){
                dataAxis.push(list[i].pr);
                data.push(list[i].num);
                if(i<10||type=="type2"){
                    seriesData.push({
                        name: list[i].pr,
                        value: list[i].num
                    });
                }
                
            }

            var yMax = 30;
            var dataShadow = [];

            for (var i = 0; i < data.length; i++) {
                dataShadow.push(yMax);
            }

            option = {

                xAxis: {
                    data: dataAxis,
                    axisLabel: {
                        interval: 5,
                        rotate: -60,
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    axisTick: {
                        show: false
                    },
                    axisLine: {
                        show: false
                    },
                    z: 10
                },
                yAxis: {
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    axisLabel: {
                        textStyle: {
                            color: '#fff'
                        }
                    }
                },
                tooltip: {},
                dataZoom: [
                    {
                        type: 'inside'
                    }
                ],
                series: [
                    { // For shadow
                        type: 'bar',
                        itemStyle: {
                            normal: {color: 'rgba(0,0,0,0.05)'}
                        },
                        barGap:'-100%',
                        barCategoryGap:'40%',
                        data: dataShadow,
                        animation: false
                    },
                    {
                        type: 'bar',
                        itemStyle: {
                            normal: {
                                color: new echarts.graphic.LinearGradient(
                                    0, 0, 0, 1,
                                    [
                                        {offset: 0, color: '#83bff6'},
                                        {offset: 0.5, color: '#188df0'},
                                        {offset: 1, color: '#188df0'}
                                    ]
                                )
                            },
                            emphasis: {
                                color: new echarts.graphic.LinearGradient(
                                    0, 0, 0, 1,
                                    [
                                        {offset: 0, color: '#2378f7'},
                                        {offset: 0.7, color: '#2378f7'},
                                        {offset: 1, color: '#83bff6'}
                                    ]
                                )
                            }
                        },
                        data: data
                    }
                ]
            };

            option1 = {
                xAxis: {
                    data: dataAxis,
                    axisLabel: {
                        interval: 5,
                        rotate: -60,
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    axisTick: {
                        show: false
                    },
                    axisLine: {
                        show: false
                    },
                    z: 10
                },
                yAxis: {
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    axisLabel: {
                        textStyle: {
                            color: '#fff'
                        }
                    }
                },
                tooltip: {},
                series: [{
                    data: data,
                    type: 'line',
                    animationEasing: 'bounceInOut',
                    animationDuration: 100
                }]
            };
            option2 = {
                // polar: {},
                // angleAxis: {
                //     axisLabel: {
                //         interval: 5,
                //         rotate: -60,
                //         textStyle: {
                //             color: '#fff'
                //         }
                //     },
                // },
                tooltip : {
                    trigger: 'item',
                    formatter: "{b} <br/>站点数 : {c} ({d}%)"
                },
                series : [
                    {
                        name: '',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '50%'],
                        data: seriesData,
                        itemStyle: {
                            emphasis: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        label: {
                            //interval: 60,
                            show:true
                        }
                    }
                ]
            };
            //console.log(option2);
            if(type=="type1"){
                myChart.setOption(option);
                myChart1.setOption(option1);
                myChart2.setOption(option2);
                
            }else if(type=="type2"){
                 
                 if(type1==1){
                    myChartb.setOption(option1);
                 }else if(type1==2){
                    myChartb.setOption(option2);
                 }else{
                    myChartb.setOption(option);
                 }
            }
            
            //myChartb.setOption(option);
            // Enable data zoom when user click bar.
            var zoomSize = 6;
            myChart.on('click', function (params) {
                console.log(dataAxis[Math.max(params.dataIndex - zoomSize / 2, 0)]);
                myChart.dispatchAction({
                    type: 'dataZoom',
                    startValue: dataAxis[Math.max(params.dataIndex - zoomSize / 2, 0)],
                    endValue: dataAxis[Math.min(params.dataIndex + zoomSize / 2, data.length - 1)]
                });
            });
        }
    </script>
</body>
</html>